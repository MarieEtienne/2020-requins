---
title: "Appropriation des données"
subtitle: "Histogramme des distances au transect et cartes d'occurrence"
author: "Léa Pautrel"
output:
  html_document:
    highlight: zenburn
    number_sections: yes
    theme: yeti
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.align = "center",
	message = FALSE,
	warning = FALSE
)

# Packages
library(dplyr)				# tidyverse
library(foreign)			# read.dbf
library(DT)						# interactive HTML datatables

## Graphes packages
library(ggplot2) ; ggplot2::theme_set(theme_light())
library(ggmap)
library(wesanderson)
library(ggpubr)
library(plotly)
library(cowplot)


## Packages calcul
library(Rdistance)
```

------------------------------------

# Importation des données
```{r import_donnees}
load("../data/effort_output.RData")
# effort_ouput : Effort data divided in multiple sub-data differing by their scale of study.

load("../data/list_prepare_obs_by_sp.RData")
# list_prepare_obs_by_sp : observation data divided in multiple sub-data differing by their scale of study.

load("../data/predata_output.RData")
# predata_output : A grid of 2km cells size with different covariable associated around the observation.

gridata <- read.dbf("../data/SPEE_CAPECET_Grid2km_modified.dbf")
# gridata : equivalent to predata from predata_output but with a extended surface
```

## effort_ouput : données d'effort (sous-données selon échelle d'étude)
```{r}
DT::datatable(summary(effort_output))
```

### legdata (transposé)
```{r}
DT::datatable(t(effort_output$legdata[1:3,]))
```

### segdata
```{r}
DT::datatable(t(effort_output$segdata[1:3,]))
```

## list_prepare_obs_by_sp$PRIGLA_obs_output : données d'observation pour le requin peau bleue (sous-données selon échelle d'étude)
```{r}
DT::datatable(summary(list_prepare_obs_by_sp$PRIGLA_obs_output))
```

### distdata
```{r}
DT::datatable(t(list_prepare_obs_by_sp$PRIGLA_obs_output$distdata[1:3,]))
```

### obsdata
```{r}
DT::datatable(t(list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[1:3,]))
```

### countdata_leg
```{r}
DT::datatable(t(list_prepare_obs_by_sp$PRIGLA_obs_output$countdata_leg[1:3,]))
```

### countdata_seg
```{r}
DT::datatable(t(list_prepare_obs_by_sp$PRIGLA_obs_output$countdata_seg[1:3,]))
```


## predata_output : covariables, grille de 2 km
```{r}
DT::datatable(summary(predata_output))
```

## gridata : covariables, surface étendue
```{r}
DT::datatable(t(gridata[1:3,]))
```


# Quelques infos utiles
## Dates des sessions
```{r}
DT::datatable(
	data.frame(
		session = effort_output$segdata$session,
		date = effort_output$segdata$date
	) %>%
		unique() %>%
		arrange(session, date) %>%
		group_by(session) %>%
		mutate(dates_session = paste0(date, collapse = " + "))  %>%
		select(session, dates_session) %>%
		unique()
)
```

```{r}
summary(list_prepare_obs_by_sp$PRIGLA_obs_output$distdata$detected)
```


# Distances au transect
## Histogramme : comptage
```{r fig.height = 4}
list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata %>% 
  ggplot(aes(x = distance)) +
  geom_histogram(bins = 15, col = "white")
```

## Histogramme : densité
```{r fig.height = 4}
list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata %>%
	gghistogram(
		x = "distance",
		y = "..density..",
		bins = 15,
		add = "mean",
		rug = TRUE,
		fill = "blue",
		col = "darkblue",
		add_density = TRUE
	)
```

## Calcul de la fonction de détection

```{r fig.width=10}
obsdata <- list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata
list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)] 
max(obsdata$distance)
```

### Comparaison des effets des différentes loi pour la vraisemblance
```{r fig.width=10}
# pointSurvey = FALSE car transects

dfuncSparrow1 <- Rdistance::dfuncEstim(distance ~ 1,
											detectionData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											siteData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											likelihood = "uniform",
											w.hi = 0.3
											)

dfuncSparrow2 <- Rdistance::dfuncEstim(distance ~ 1,
											detectionData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											siteData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											likelihood = "halfnorm",
											w.hi = 0.3
											)


dfuncSparrow3 <- Rdistance::dfuncEstim(distance ~ 1,
											detectionData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											siteData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											likelihood = "hazrate",
											w.hi = 0.3
											)


dfuncSparrow4 <- Rdistance::dfuncEstim(distance ~ 1,
											detectionData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											siteData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											likelihood = "negexp",
											w.hi = 0.3
											)


dfuncSparrow5 <- Rdistance::dfuncEstim(distance ~ 1,
											detectionData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											siteData = list_prepare_obs_by_sp$PRIGLA_obs_output$obsdata[,c(1,3)],
											likelihood = "Gamma",
											w.hi = 0.3
											)
```


```{r fig.width=10}
par(mfrow=c(2,3))
plot(dfuncSparrow1)
plot(dfuncSparrow2)
plot(dfuncSparrow3)
plot(dfuncSparrow4)
plot(dfuncSparrow5)
```


# Carte d'occurrences
```{r fig.height = 8}
data_occ <- list_prepare_obs_by_sp$PRIGLA_obs_output$distdata %>%
	filter(detected == 1)
segdata <- effort_output$segdata

# Emplacement
sbbox <- make_bbox(lon = c(min(data_occ$longitude), max(data_occ$longitude)),
									 lat = c(min(data_occ$latitude), max(data_occ$latitude)),
									 f = 1.4)

# Création de la carte vide
zone_obs <- get_map(location = sbbox,
										zoom = 8,
										maptype =  "terrain")

zone_obs_map = ggmap(zone_obs) + theme_void()

# Carte avec les points
zone_obs_map +
	geom_path(
		data = segdata,
		mapping = aes(x = longitude, y = latitude, group = Transect.Label),
		size = 0.3,
		colour = alpha("black", 0.2)
	) +
	geom_point(data = data_occ,
						 aes(x = longitude,
						 		y = latitude,
						 		col = session)) +
	theme_void() +
	scale_color_manual(values = wesanderson::wes_palette("BottleRocket1", n = 4))
	
```

